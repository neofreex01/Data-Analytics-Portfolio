---
title: "Problem set 1 Research Design"
author: "Hung-Hsiang Chien"
output:
  html_document:
    keep_md: true
    df_print: paged
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, 
                      fig.path = "./figure/figure")
```

# 1. Wage overview in Italia
This question aims to answer the relationship between wage and age in Italy. Moreover, it also would like to discover if there is any difference of the relationship between male and female.
```{r warning = FALSE, echo=FALSE}
library(lubridate)
library(stringr)
library(tidyverse)
library(data.table)
library(stargazer)
library(moderndive)
library(haven)
library(mfx)
```
First, we need to import datasets from the console
```{r warning = FALSE}
 ps1 = read_csv("./dataset/ps1.csv", 
                col_types = cols(log_dailywages = col_number()))

```

## (a) Data process

```{r  mesage=FALSE, warning=FALSE}
dataset=ps1 %>%
  mutate(female = if_else(sex=="F",1,0),age=2001-birth)
```

## (b) Wage distribution against age

With the distribution, we can find the wage increases as age becomes larger. However, we can also find a decreasing marginal effect of age.

```{r fig.align="center"}
wage_distribute= dataset %>%
  group_by(age) %>%
  # Use the raw data of wage to plot
  summarise(wage_avg=mean(exp(log_dailywages))) %>%
  ggplot(aes(x=age,y=wage_avg))+
  geom_bar(stat="identity",fill="red")+
  labs(title="Wage of individuals across the age")+
  labs(x="Age", y="Wage(in average)")+
  guides(colour=guide_legend(title.theme=NULL))+
  theme(legend.position = "bottom") + 
  theme_bw()
  

wage_distribute

```

## (c) Regression

With the wage vs age distribution, I use a regression to obtain an expectation wage condition on age, i.e. uses age as a predictor to estimate the expectation value of wage. Then, I look into the summary statistics of the coefficients of each age. As we can see, the effect of the age is different from 0.02 to 0.57 and the avarage effect of the age is 0.37 (log(wage)).

```{r}
dataset$age =as.factor(dataset$age)
model_1=lm(data = dataset, log_dailywages~age)
stargazer(model_1, type="html", style = "qje",
          omit        = "age",
          omit.labels = "Ommited Age Dummies")
model1coef<-model_1$coefficients
agedummies <- model1coef[(2:61)]
model.data1 <-data.frame(agedummies)
stargazer(model.data1, type="html", style="qje",
          title            = "Summary Age Dummies",
          summary.stat = c("n", "min","max","mean", "sd"))

```

## (d) Male and Female wage distribution
Now, I look into the wage distributioni of male and female separately, then we can find the trends are somehow different, which means the relationships between age and wage are different within these two groups.
```{r fig.align="center"}
gender_label = c('male', 'female')
names(gender_label) = c(0, 1)
# wage_male_distribute = 
  dataset %>%
  mutate(female = as.factor(female)) %>%
  # filter(female=="0") %>%
  group_by(age, female) %>%
  summarise(wage_avg=mean(exp(log_dailywages))) %>%
  ungroup() %>%
  ggplot(aes(x=as.integer(as.character(age)),y=wage_avg, fill = female))+
  geom_bar(stat="identity")+
  labs(title="Wage of individuals across the age grouped by gender")+
  labs(x="Age", y="Wage(in average)", fill = 'gender')+
  theme(legend.position = "bottom") + 
  facet_grid(~ female , labeller = labeller(female = gender_label)) + 
  scale_fill_manual(values = c('#70c1b3','#f25f5c'))+
  theme_bw() +
  theme(strip.background = element_rect(
     color="black", fill="transparent", size=1.5, linetype="solid"
     ))



```

<!-- ##(e) -->

<!-- ```{r} -->

<!-- model_2=lm(log_dailywages~age+female+female*age,data=dataset) -->
<!-- stargazer(model_2, type="text", style = "qje", -->
<!--           omit = "age", -->
<!--           omit.labels = "Omitted Age variables ") -->
<!-- model2coef<-model_2$coefficients -->
<!-- agedummies <- model2coef[(2:61)] -->
<!-- age.female <-model2coef[(63:122)] -->
<!-- model.data2 <-data.frame(agedummies, age.female) -->

<!-- stargazer(model.data2, type="text", style = "qje", -->
<!--           title            = "Summary Age Dummies", -->
<!--           summary.stat = c("n", "min","max","mean", "sd")) -->

<!-- ``` -->

## (e) Add the squared age variable
As we can see the decreasing positive correlation of age and wage, I add the squared term of age into the regression and the cofficients are significant.
```{r fig.align="center"}

dataset$age = as.numeric(as.character(dataset$age))
model_3=lm(log_dailywages~female+age+I(age^2),data=dataset)
stargazer(model_3,type="text", style="qje",
          covariate.labels = c("female","age","$age^{2}$","intercept")
         )
```


##(f) Compare the prediction and true value of different gender

The prediction is very similar to the expectation value. However, when age increases, we can find that the conditional mean of male and femael start to diverse. Perhaps, we could also use an interaction term between female and the squared term of the age variable.

```{r, }
df = dataset %>% 
  group_by(age,female) %>%
  summarise(avg_wage=mean(log_dailywages))


prediction=get_regression_points(model_3) %>%
  group_by(age,female) %>%
  summarise(avg_wage=mean(log_dailywages),wage_hat=mean(log_dailywages_hat))
  

ggplot(prediction,aes(x=age,shape=as.factor(female)))+
  geom_point(aes(y=avg_wage))+
  geom_smooth(aes(y=wage_hat,color=as.factor(female)))+
  geom_point(aes(y=wage_hat,color=as.factor(female)))+
  scale_shape_discrete(labels=c("male","female"))+
  scale_color_discrete(labels=c("male","female"))+
  theme(legend.title=element_blank())+
  labs(title="Prediction vs Conditioinal Mean")+
  labs(x="Age",y="wage(daily)")+
  theme(panel.border = element_blank()) + 
  guides(color = guide_legend("Prediction",
                              override.aes=list(fill=NA)), 
         shape = guide_legend("Conditional mean")) +
  theme_bw()

```

# 2. Replication of Olken (2007)

Brief introduction: This paper tries to investigate if the treatments (audtion, invitation and comment) are effective to decrease corruption in Indonesia. The author used a randomized field experiment to test the treatment effect of each treatment. There are 6 (2*3) controlled and treated groups (control/audit vs control/invite/comment) in the research. 

## (a) The assumption necessary to estimate the treatment effect.
One of the most important assumption would be  SUTVA (Stable Unit Treatment Value Assumption), which means no spillover effect among controlled groups and treated groups. For example, for villages assigned to control group, they might hear the auditors went to other vaillages and therefore be aware of that and reduce the amount/probabilty of corruption. Olken use the distance to the nearest audit village to test if there is any spillover effect in the experiment, yet he suggests no impact of spillover effect.
```{r}
# Import the data
Olken <- read_dta("./dataset/Olken.dta")
# Tramsform the data
Olken=Olken %>%
  mutate(auditstratnum=factor(auditstratnum))
```

## (b)


```{r}
 
model1<-lm(lndiffeall3mat ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum,data=Olken)
model2<-lm(lndiffeburuh ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum,data=Olken)
model3<-lm(lndiffeall4 ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum,data=Olken)
model4<-lm(lndiffeall4mainancil ~audit_rand+ undfpm_rand+ fpm_rand+ auditstratnum,data=Olken)
stargazer(model1, model2, model3, model4, type="text",
          omit        = "auditstratnum",
          omit.labels = "Ommited Stratum Fix Effects")

```

## (c)

Table 2 shows the relationship between village and treatments. We use a probit model where the dependent variables are treatment dummies. We can see that village characteristics do not siginifcantly affect the dummies and the coefficient is very small.

```{r}
model1 <- probitmfx(audit_rand ~ 
              zpop + totalmesjid + totalallocation + z4RABnumsubproj
            + zpercentpoorpra + zdistancekec + zkadesedyears
            + zkadesage + zkadesbengkoktotal + podeszhill
            , data = Olken, clustervar1 = "kecid")

model2 <- probitmfx(und_rand ~ 
              zpop + totalmesjid + totalallocation + z4RABnumsubproj
            + zpercentpoorpra + zdistancekec + zkadesedyears
            + zkadesage + zkadesbengkoktotal + podeszhill
            , data = Olken
            , clustervar1 = "kecid")

data_cond <- Olken %>%
  filter(undfpm_rand == 1)

model3 <- probitmfx(fpm_rand ~ 
                    zpop + totalmesjid + totalallocation + z4RABnumsubproj
                  + zpercentpoorpra + zdistancekec + zkadesedyears
                  + zkadesage + zkadesbengkoktotal + podeszhill
                  , data = data_cond
                  , clustervar1 = "kecid")                          
stargazer(model1$mfxest, model2$mfxest, model3$mfxest, type = 'text', header = F)

```


## (d)

```{r}
Olken=Olken %>%
  mutate(corruption = lndiffeall4mainancil*totalprojusd) %>%
  mutate(realcorruption=corruption-1200) %>%
  mutate(true_realcorruption=if_else(realcorruption<0,0,realcorruption))

```

## (e) 

```{r mesage=FALSE, warning=FALSE}


model1 <- lm(true_realcorruption ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum,data=Olken)
stargazer(model1, type='html',
          omit = "auditstratnum",
          omit.labels = "Ommited Stratum Fix Effects")
```



## (f)

```{r}

Olken=Olken %>%
  mutate(corruption_min = if_else(corruption>0,1,0)) %>%
  mutate(corruption_bad = if_else(corruption>1200,1,0)) 
  
model2<-lm(corruption_min ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum ,data=Olken)
model3<-lm(corruption_bad ~ audit_rand + undfpm_rand+ fpm_rand+ auditstratnum, data=Olken)

stargazer(model1, model2, model3, 
          type="text",
          omit        = "auditstratnum",
          omit.labels = "Ommited Stratum Fix Effects")



```